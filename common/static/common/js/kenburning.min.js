/***
Ken Burning - Luis Jarufe v0.1
***/

(function ($) {
    var methods = {
        init: function (user_options) {
            var options = $.extend({}, $.fn.kenBurning.defaultSettings, user_options);

            var zoomMax = (100 * options.zoom) + "%";
            var zoomStepIn = (((options.zoom - 1) * 20) + 100) + "%";
            var zoomStepOut = (((options.zoom - 1) * 80) + 100) + "%";

            var timeStep1 = options.time * 0.2;
            var timeStep2 = options.time * 0.8;

            var $this = $(this);
            $this.addClass('kenburning-container');
            var num_elem = $this.children("img").size();
            var num_loop = 0;

            return this.each(function() {
                // Autoplay del efecto
                var autoplay = setInterval(function() {
                    // al pasar por todas las fotos el autoplay se detiene
                    if(num_loop == num_elem)
                        clearInterval(autoplay);

                    var $active = $this.find('img.active');
                    var $nav_active = options.controls_container.find(".active");
                    $nav_active.removeClass("active");

                    if ($active.length === 0) { $active = $this.find('img:last'); }

                    var $next;
                    if($active.next().length) {
                        $next = $active.next()
                        $nav_active.next().addClass("active");
                    }
                    else {
                        $next = $this.find('img:first')
                        options.controls_container.find(".nav:first").addClass("active");
                    }

                    $active.addClass('last-active').removeClass('active');

                    if (options.animation === "in") {
                        $next.css({
                            left	:	"0",
                            right	:	"auto",
                            opacity	:	0.0,
                            width	:	"100%"
                        })
                            .addClass('active')
                            .animate({opacity: 1.0, width: zoomStepIn}, timeStep1, "linear")
                            .animate({width: zoomMax}, timeStep2, "linear", function () {
                                $active.removeClass('last-active');
                            });
                        options.animation = "out";
                    } else {
                        $next.css({
                            left : "auto",
                            right : "0",
                            opacity : 0.0,
                            width : zoomMax
                        })
                            .addClass('active')
                            .animate({opacity: 1.0, width: zoomStepOut}, timeStep1, "linear")
                            .animate({width: "100%"}, timeStep2, "linear", function () {
                                $active.removeClass('active last-active');
                            });
                        options.animation = "in";
                    }
                    num_loop++;
                }, options.time);

                // Mover a una posición específica
                var move_position = function(num) {
                    var $active = $this.find('img.active');
                    var $next = $this.find("img[pos=" + num + "]");
                    $next.addClass("hola");

                    $active.addClass('last-active').removeClass('active');

                    if (options.animation === "in") {
                        $next.css({
                            left	:	"0",
                            right	:	"auto",
                            opacity	:	0.0,
                            width	:	"100%"
                        })
                            .addClass('active')
                            .animate({opacity: 1.0, width: zoomStepIn}, timeStep1, "linear")
                            .animate({width: zoomMax}, timeStep2, "linear", function () {
                                $active.removeClass('last-active');
                            });
                        options.animation = "out";
                    } else {
                        $next.css({
                            left : "auto",
                            right : "0",
                            opacity : 0.0,
                            width : zoomMax
                        })
                            .addClass('active')
                            .animate({opacity: 1.0, width: zoomStepOut}, timeStep1, "linear")
                            .animate({width: "100%"}, timeStep2, "linear", function () {
                                $active.removeClass('active last-active');
                            });
                        options.animation = "in";
                    }
                };

                // Eventos de los controladores
                options.controls_container.children(".nav").bind("click", function() {
                    clearInterval(autoplay);
                    move_position($(this).attr("pos"));
                    options.controls_container.find(".active").removeClass("active");
                    $(this).addClass("active");
                });
            });
        }
    };

     $.fn.kenBurning = function(method) {
        if(methods[method]) {
            return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
        } else if(typeof method === 'object' || ! method) {
            return methods.init.apply( this, arguments );
        } else {
            $.error( 'Method ' +  method + ' does not exist on jQuery.tooltip' );
        }
    };

    $.fn.kenBurning.defaultSettings = {
        controls_container: $(this),
        zoom: 1.2,
        time: 6000,
        animation: "in"
    };
})(jQuery);